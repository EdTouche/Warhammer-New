
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warhammer 40K Codex Librarium</title>
  <style>
    body {
      background-color: #0b0b0b;
      color: #e0e0e0;
      font-family: 'Verdana', sans-serif;
      padding: 20px;
    }
    .card {
      background-color: #1a1a1a;
      padding: 20px;
      border: 1px solid #444;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .filters {
      margin-bottom: 20px;
    }
    select {
      padding: 5px;
      margin-right: 10px;
      background: #111;
      color: white;
    }
    button {
      background-color: #222;
      color: white;
      border: 1px solid #555;
      padding: 5px 10px;
      margin-top: 10px;
      cursor: pointer;
    }
    #save-status {
      margin: 10px 0;
      color: lime;
    }
  </style>
</head>
<body>
  <h1>⚔️ Warhammer 40K Codex Librarium</h1>

  <div class="filters">
    <label for="faction">Faction:</label>
    <select id="faction" onchange="renderBooks()">
      <option value="">All</option>
    </select>

    <label for="era">Era:</label>
    <select id="era" onchange="renderBooks()">
      <option value="">All</option>
    </select>

    <label for="read">Read:</label>
    <select id="read" onchange="renderBooks()">
      <option value="">All</option>
      <option value="true">Read</option>
      <option value="false">Unread</option>
    </select>
  </div>

  <div id="save-status"></div>
  <div id="book-list"></div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRDw80CuG5loPqg1iw9vFRZmt4A2T63EqoYTGpocCMxXAC8W39AbZYbCHZFoKUekcynZLy8TOxCEaEZ/pub?gid=2115745400&single=true&output=csv";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx3seCmeQrcFh7WiSBYMMsEm31B0wWzmUmHqShPqjbPbvG3yjvMvO_Rs5Fj5TZpB_TrtQ/exec";

    let books = [];

    async function loadBooks() {
      const res = await fetch(SHEET_URL + "&t=" + new Date().getTime());
      const text = await res.text();
      const lines = text.split("\n").slice(1);
      books = lines.map(row => {
        const [series, bookNumber, title, author, era, faction, readStatus] = row.split(",");
        return {
          series, bookNumber, title, author, era, faction,
          read: readStatus?.trim() === "1"
        };
      });
      populateFilters();
      renderBooks();
    }

    function populateFilters() {
      const factionSet = new Set();
      const eraSet = new Set();
      books.forEach(b => {
        if (b.faction) factionSet.add(b.faction.trim());
        if (b.era) eraSet.add(b.era.trim());
      });
      const factionSelect = document.getElementById("faction");
      const eraSelect = document.getElementById("era");

      [...factionSet].sort().forEach(f => {
        factionSelect.innerHTML += `<option value="${f}">${f}</option>`;
      });
      [...eraSet].sort().forEach(e => {
        eraSelect.innerHTML += `<option value="${e}">${e}</option>`;
      });
    }

    function renderBooks() {
      const factionFilter = document.getElementById("faction").value;
      const eraFilter = document.getElementById("era").value;
      const readFilter = document.getElementById("read").value;

      const container = document.getElementById("book-list");
      container.innerHTML = "";

      books.forEach(book => {
        if ((factionFilter && book.faction !== factionFilter) ||
            (eraFilter && book.era !== eraFilter) ||
            (readFilter && String(book.read) !== readFilter)) {
          return;
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h2>${book.title}</h2>
          <p><strong>Author:</strong> ${book.author}</p>
          <p><strong>Era:</strong> ${book.era} | <strong>Faction:</strong> ${book.faction}</p>
          <button onclick="toggleRead('${book.title}')">${book.read ? "Mark as Unread" : "Mark as Read"}</button>
        `;
        container.appendChild(card);
      });
    }

    function toggleRead(title) {
      const book = books.find(b => b.title === title);
      if (!book) return;
      book.read = !book.read;

      document.getElementById("save-status").textContent = "Saving...";

      fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: book.title, read: book.read ? "TRUE" : "FALSE" })
      })
        .then(res => res.text())
        .then(txt => {
          document.getElementById("save-status").textContent = "✔ " + txt;
          renderBooks();
          setTimeout(() => {
            document.getElementById("save-status").textContent = "";
          }, 3000);
        })
        .catch(() => {
          document.getElementById("save-status").textContent = "⚠ Failed to save read status.";
        });
    }

    loadBooks();
  </script>
</body>
</html>
